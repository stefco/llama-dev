FROM stefco/llama-base:alpine

COPY . /home/llama/provision

# put metadata in /docker-meta.yml
ARG NAME
ARG VERSION
ARG COMMIT
ARG URL
ARG BRANCH
ARG DATE
ARG REPO
ARG DOCKER_TAG
ARG DOCKERFILE_PATH
RUN echo >>/docker-meta.yml "- name: ${NAME}" \
    && echo >>/docker-meta.yml "  version: ${VERSION}" \
    && echo >>/docker-meta.yml "  commit: ${COMMIT}" \
    && echo >>/docker-meta.yml "  url: ${URL}" \
    && echo >>/docker-meta.yml "  branch: ${BRANCH}" \
    && echo >>/docker-meta.yml "  date: ${DATE}" \
    && echo >>/docker-meta.yml "  repo: ${REPO}" \
    && echo >>/docker-meta.yml "  docker_tag: ${DOCKER_TAG}" \
    && echo >>/docker-meta.yml "  dockerfile_path: ${DOCKERFILE_PATH}" \
    && echo >>/docker-meta.yml "  dockerfile: |" \
    && sed >>/docker-meta.yml 's/^/    /' \
        </home/llama/provision/"${DOCKERFILE_PATH}"

# install git-lfs and conda
RUN su llama -c "bash -i -c ' \
    cd ~ \
        && type conda \
        && conda env create -f ~/provision/llama-py37.yml \
        && echo conda\ activate\ llama-py37\ >>~/.bashrc \
        && cat ~/.bashrc \
        && source ~/.bashrc \
        && pip install -r ~/provision/requirements.txt \
        && rm -r ~/miniconda3/pkgs \
'" \
    && apk --no-cache add git openssh graphviz font-bitstream-type1 \
    && rm -rf /home/llama/provision
USER llama
WORKDIR /home/llama
