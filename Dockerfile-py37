# For building and uploading conda packages and environments
FROM stefco/llama-env:py37

USER root
COPY requirements-dev.txt /home/llama/requirements-dev.txt
RUN printf '{"source_branch": "%s", "source_commit": "%s", "image_name": "%s"}' \
        "${SOURCE_BRANCH}" "${SOURCE_COMMIT}" "${IMAGE_NAME}" >/docker-info.json \
    && apk --no-cache add vim make rsync git texlive-full \
    && su llama -c 'bash -i -c " \
        conda install anaconda-client conda-build \
            && pip install -r /home/llama/requirements-dev.txt \
            && pip install git+https://github.com/stefco/pypiprivate.git \
            && rm -r ~/miniconda3/pkgs \
    "' \
    && rm /home/llama/requirements-dev.txt
USER llama
